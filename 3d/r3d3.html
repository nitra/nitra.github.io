<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Payment Request</title>
  <link rel='stylesheet prefetch' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css'>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <title>Payment Request</title>
  <style>
    .loader {
      border: 16px solid #f3f3f3;
      /* Light grey */
      border-top: 16px solid #3498db;
      /* Blue */
      border-radius: 50%;
      width: 120px;
      height: 120px;
      animation: spin 2s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
  </style>
  <div id="loader" class="loader"></div>
  <div id="modal" class="hidden">
    <div class="bt-mask"></div>
    <div class="bt-modal-frame">
      <div class="bt-modal-header">
        <div class="header-text">Authentication</div>
      </div>
      <div class="bt-modal-body"></div>
      <div class="bt-modal-footer">
        <a id="text-close" href="#">Cancel</a>
      </div>
    </div>
  </div>
</body>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
<script src='https://js.braintreegateway.com/web/3.32.1/js/client.min.js'></script>
<script src='https://js.braintreegateway.com/web/3.32.1/js/three-d-secure.js'></script>
<!-- <script src='https://js.braintreegateway.com/web/3.32.1/js/hosted-fields.js'></script> -->
<script src="https://js.braintreegateway.com/web/3.32.1/js/payment-request.min.js"></script>
<script type="text/javascript">
  var modal = document.getElementById('modal')
  var bankFrame = document.querySelector('.bt-modal-body')
  var payGroup = document.querySelector('.pay-group')
  var my3DSContainer = document.createElement('div');
  var nonceGroup = document.querySelector('.nonce-group')

  var closeFrame = document.getElementById('text-close')
  closeFrame.addEventListener('click', function () {
    components.threeDSecure.cancelVerifyCard(removeFrame())
  })

  var components = {
    client: null,
    threeDSecure: null,
    paymentRequest: null
  }

  window.fetch('http://127.0.0.1:8080/gettoken')
    //'https://us-central1-tests-197316.cloudfunctions.net/testconfig')//, {
    //     headers: {
    //     'Access-Control-Allow-Origin':'*'
    // },
    //  mode: 'no-cors',
    //   method: 'get'
    // }/*'https://us-central1-nitra-p.cloudfunctions.net/testRuntimeconfig'*/)
    .then(function (response) {
      return response.text()
    }).then(function (clientToken) {
      braintree.client.create({
        authorization: clientToken
      }, onClientCreate)
    })

  function onClientCreate(err, clientInstance) {
    console.log('clientInstance', clientInstance)
    if (err) {
      console.log('client error:', err)
      return
    }

    components.client = clientInstance

    braintree.paymentRequest.create({
      client: clientInstance
    }, function (err, instance) {
      if (err) {
        // Handle errors from creating payment request instance
      }

      components['paymentRequest'] = instance

      console.log('instance - ', instance)

      document.getElementById("loader").style.display = "none";
      var amount = '100.00'
      var tok = {
        details: {
          total: {
            label: 'Total',
            amount: {
              currency: 'USD',
              value: amount
            }
          }
        }
      }

      check3d(tok, amount)

    });

    braintree.threeDSecure.create({
      client: clientInstance
    }, function (createErr, threeDSecureInstance) {
      components['threeDSecure'] = threeDSecureInstance
    })

  }

  function check3d(tok, amount) {

    components.paymentRequest.tokenize(tok, function (err, payload) {
      if (err) {
        console.error('tokenization error:', err)

        return
      } else {
        console.log('tokenization success:', payload)
      }

      components.threeDSecure.verifyCard({
        nonce: payload.nonce,
        amount: amount,
        addFrame: function (err, iframe) {
          var bankFrame = document.querySelector('.bt-modal-body')
          var modal = document.getElementById('modal')
          modal.classList.remove('hidden')
          bankFrame.appendChild(iframe);
          // documentappendChild(bankFrame);
        },
        removeFrame: function () {
          var bankFrame = document.querySelector('.bt-modal-body')
          var modal = document.getElementById('modal')
          modal.classList.add('hidden')
          // document.body.removeChild(bankFrame);
        }
      }, function (err, verification) {
        if (err) {
          console.log(err)
          return
        }

        console.log('verification success:', verification)
        // nonceInput.value = verification.nonce
        if (verification.liabilityShifted) {
          //          fetch('https://us-central1-nitra-p.cloudfunctions.net/checkout', {
          fetch('http://127.0.0.1:8080/checkout', {
            body: 'payment_method_nonce=' + verification.nonce + '&email=v@nitra.ai',
            headers: {
              'content-type': 'application/x-www-form-urlencoded'
            },
            method: 'post'
          }).then(function (res) {
            fetch('http://127.0.0.1:8080/customercreate', {
              body: /*'payment_method_nonce=' + */verification.nonce/* + '&email=v@nitra.ai'*/,
              headers: {
                'content-type': 'application/x-www-form-urlencoded'
              },
              method: 'post'
            }).then(function(res){
              console.log('create customer')
            })
          }).catch(function (err) {
              console.log('error - ', err)
          })
        } else {
          console.error("Couldn't create 3-D Secure transaction")
        }
      })
    })

  }
</script>
</body>

</html>